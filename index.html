<?php
// list.php
declare(strict_types=1);

/**
 * –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏—Å—Ç–∏–Ω–≥ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π.
 *
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ GET:
 *  - path  : –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥ –≤–Ω—É—Ç—Ä–∏ –±–∞–∑–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é '.')
 *  - depth : –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ —Ä–µ–∫—É—Ä—Å–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)
 *  - format: 'html' –∏–ª–∏ 'txt' (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'html')
 */

// –ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ‚Äî —Å–∫—Ä–∏–ø—Ç –Ω–µ –ø–æ–∫–∏–Ω–µ—Ç –µ—ë
$baseDir = realpath(__DIR__);
if ($baseDir === false) {
    http_response_code(500);
    echo "Server error: cannot resolve base dir";
    exit;
}

$requested = isset($_GET['path']) ? $_GET['path'] : '.';
$maxDepth = isset($_GET['depth']) ? (int)$_GET['depth'] : 10;
$format = (isset($_GET['format']) && $_GET['format'] === 'txt') ? 'txt' : 'html';

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –∑–∞–ø—Ä–µ—â–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –∏ –ø—É—Ç—å —Å –Ω—É–ª—è–º–∏
if (strpos($requested, "\0") !== false) {
    http_response_code(400);
    echo "Bad request";
    exit;
}

// –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω –≤–Ω—É—Ç—Ä–∏ $baseDir
$fullPath = realpath($baseDir . DIRECTORY_SEPARATOR . $requested);
if ($fullPath === false) {
    http_response_code(404);
    echo "Path not found";
    exit;
}
if (strpos($fullPath, $baseDir) !== 0) {
    http_response_code(403);
    echo "Access denied";
    exit;
}

// –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–æ–≤ –ø–æ symlink-–∞–º –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å visited realpaths
$visited = [];

function list_dir(string $path, int $maxDepth, int $curDepth, array &$visited, string $baseDir): array {
    $result = [];

    // realpath –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å false –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ
    $rp = realpath($path);
    if ($rp === false) return $result;

    // –ï—Å–ª–∏ —É–∂–µ –ø–æ—Å–µ—â–∞–ª–∏ ‚Äî —Ü–∏–∫–ª, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if (in_array($rp, $visited, true)) return $result;
    $visited[] = $rp;

    // –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏
    $items = @scandir($rp);
    if ($items === false) return $result;

    foreach ($items as $name) {
        if ($name === '.' || $name === '..') continue;
        $itemPath = $rp . DIRECTORY_SEPARATOR . $name;

        // —Å–æ–±–∏—Ä–∞–µ–º –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        $isLink = is_link($itemPath);
        $isDir = is_dir($itemPath);
        $isFile = is_file($itemPath);

        $entry = [
            'name' => $name,
            'path' => $itemPath,
            'realpath' => $isLink ? @realpath($itemPath) : $itemPath,
            'type' => $isDir ? 'dir' : ($isFile ? 'file' : ($isLink ? 'link' : 'other')),
            'size' => $isFile ? filesize($itemPath) : null,
            'children' => [],
        ];

        // –ï—Å–ª–∏ –∫–∞—Ç–∞–ª–æ–≥ –∏ –µ—Å—Ç—å –∑–∞–ø–∞—Å –≥–ª—É–±–∏–Ω—ã ‚Äî —Ä–µ–∫—É—Ä—Å–∏—Ä—É–µ–º (–Ω–æ –Ω–µ –ø–æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–º —Å—Å—ã–ª–∫–∞–º)
        if ($isDir && $curDepth < $maxDepth && !$isLink) {
            // –ï—â—ë –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –¥–æ—á–µ—Ä–Ω–µ–π –ø–∞–ø–∫–∏ –≤—Å—ë –µ—â—ë –≤–Ω—É—Ç—Ä–∏ baseDir
            $childReal = realpath($itemPath);
            if ($childReal !== false && strpos($childReal, $baseDir) === 0) {
                $entry['children'] = list_dir($itemPath, $maxDepth, $curDepth + 1, $visited, $baseDir);
            } else {
                // –Ω–µ —Ä–µ–∫—É—Ä—Å–∏—Ä—É–µ–º, –µ—Å–ª–∏ –≤—ã—à–ª–∏ –∑–∞ –±–∞–∑—É
                $entry['note'] = 'out-of-base-or-unreadable';
            }
        }

        $result[] = $entry;
    }

    return $result;
}

$tree = list_dir($fullPath, $maxDepth, 0, $visited, $baseDir);

// –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞
if ($format === 'txt') {
    header('Content-Type: text/plain; charset=utf-8');
    $printTxt = function(array $nodes, int $depth = 0) use (&$printTxt) {
        $out = '';
        $pad = str_repeat('  ', $depth);
        foreach ($nodes as $n) {
            $out .= $pad . $n['name'] . ($n['type'] === 'dir' ? '/' : '') . PHP_EOL;
            if (!empty($n['children'])) {
                $out .= $printTxt($n['children'], $depth + 1);
            }
        }
        return $out;
    };
    echo "Listing of: " . $fullPath . PHP_EOL . PHP_EOL;
    echo $printTxt($tree);
} else {
    header('Content-Type: text/html; charset=utf-8');
    echo "<!doctype html><meta charset=\"utf-8\"><title>Listing of " . htmlspecialchars($fullPath) . "</title>";
    echo "<style>body{font-family:monospace;font-size:14px} ul{list-style:none;margin:0;padding-left:1em} li.dir{font-weight:700}</style>";
    echo "<h2>Listing of " . htmlspecialchars($fullPath) . "</h2>";

    $render = function(array $nodes) use (&$render) {
        echo "<ul>";
        foreach ($nodes as $n) {
            $escName = htmlspecialchars($n['name']);
            $cls = $n['type'] === 'dir' ? 'dir' : 'file';
            echo "<li class=\"" . $cls . "\">";
            if ($n['type'] === 'dir') {
                echo "üìÅ " . $escName;
            } elseif ($n['type'] === 'file') {
                echo "üìÑ " . $escName . ($n['size'] !== null ? " (" . number_format($n['size']) . " bytes)" : "");
            } elseif ($n['type'] === 'link') {
                $target = htmlspecialchars((string)$n['realpath']);
                echo "üîó " . $escName . " ‚Üí " . $target;
            } else {
                echo $escName;
            }
            if (!empty($n['children'])) {
                $render($n['children']);
            }
            echo "</li>";
        }
        echo "</ul>";
    };

    $render($tree);
}
